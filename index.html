<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard BARBER√çA ESTILO CL√ÅSICO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #2c2c2c;
        }
        /* PALETA BARBER√çA: NEGRO (#1a1a1a), GRIS OSCURO (#333), GRIS MEDIO (#666), GRIS CLARO (#999) */
        /* ESTILOS DE LOGIN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1rem;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a1a1a;
        }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #1a1a1a;
        }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .login-btn:hover {
            transform: translateY(-2px);
        }
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .security-info {
            background: #e9ecef;
            color: #495057;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }
        /* ESTILOS DEL DASHBOARD */
        .dashboard-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-email {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }
        .logout-btn {
            background: #666;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: #999;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s ease;
            border-left: 4px solid #1a1a1a;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #1a1a1a;
        }
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card h2::before {
            content: '‚úÇÔ∏è';
            font-size: 1.2em;
        }
        /* ESTILOS PARA CATEGOR√çAS Y BARBEROS */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .category-item {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #1a1a1a;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .category-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .category-item.selected {
            background: #1a1a1a;
            color: white;
        }
        .category-count {
            font-size: 1.5em;
            font-weight: bold;
        }
        /* ESTILOS PARA BARBEROS */
        .barberos-section {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .barberos-section.active {
            display: block;
        }
        .barberos-title {
            color: #495057;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .barberos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .barbero-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .barbero-item:hover {
            border-color: #1a1a1a;
            background: #f8f8f8;
        }
        .barbero-item.selected {
            border-color: #1a1a1a;
            background: #1a1a1a;
            color: white;
        }
        .barbero-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .barbero-count {
            font-size: 1.2em;
            color: #1a1a1a;
        }
        .barbero-item.selected .barbero-count {
            color: white;
        }
        .barberos-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #0c5460;
        }
        .all-barberos-btn {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .all-barberos-btn:hover {
            background: #555;
        }
        .all-barberos-btn.active {
            background: #666;
        }
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        .form-group textarea:focus {
            outline: none;
            border-color: #1a1a1a;
        }
        .form-group input[type="file"],
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f8f8;
        }
        .form-group input[type="file"] {
            border-style: dashed;
            cursor: pointer;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        button {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(26, 26, 26, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-test {
            background: #333;
            color: white;
        }
        .btn-load {
            background: #666;
            color: white;
        }
        .btn-manual {
            background: #1a1a1a;
            color: white;
        }
        .btn-stats {
            background: #333;
            color: white;
        }
        .btn-warning {
            background: #999;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            flex: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #1a1a1a;
        }
        .loading.active {
            display: block;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .alert.show {
            display: block;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a1a1a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        .progress-container.active {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .progress-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }
        .progress-info div {
            text-align: center;
            padding: 5px;
            background: #f8f8f8;
            border-radius: 5px;
        }
        .batch-info {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }
        .batch-info.active {
            display: block;
        }
        .batch-info h4 {
            color: #495057;
            margin-bottom: 10px;
        }
        .batch-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .batch-stat {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .batch-stat .number {
            font-size: 1.2em;
            font-weight: bold;
            color: #1a1a1a;
        }
        .batch-stat .label {
            font-size: 0.8em;
            color: #666;
        }
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #1a1a1a;
        }
        .chart-container h3 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #1a1a1a;
            text-align: center;
        }
        .chart-canvas {
            position: relative;
            height: 300px;
        }
        .manual-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
            border-top: 4px solid #333;
        }
        .manual-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .manual-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        .manual-item {
            padding: 5px 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        .manual-item:last-child {
            border-bottom: none;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            background: #f8f8f8;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #1a1a1a;
        }
        .tab.active {
            background: #1a1a1a;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
            border-top: 4px solid #1a1a1a;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(26, 26, 26, 0.3);
        }
        .metric-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .metric-card.error {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }
        .metric-card.rate {
            background: linear-gradient(135deg, #333 0%, #666 100%);
        }
        .metric-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .filters-container {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .table-header {
            background: #1a1a1a;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th,
        td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f8f8f8;
            font-weight: 600;
            color: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr:hover {
            background: #f8f8f8;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-enviado {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-small {
            height: 250px;
        }
        .optimization-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        /* ESTILOS PARA CONTROL DE BARBEROS - NUEVO DISE√ëO PROFESIONAL */
        .comandera-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
            border-top: 4px solid #1a1a1a;
        }
        .comandera-header {
            background: linear-gradient(135deg, #1a1a1a, #333);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        .comandera-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1" fill="white" opacity="0.1"/><circle cx="90" cy="20" r="1" fill="white" opacity="0.1"/><circle cx="20" cy="90" r="1" fill="white" opacity="0.1"/><circle cx="80" cy="80" r="1" fill="white" opacity="0.1"/></svg>') repeat;
        }
        .comandera-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }
        .comandera-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .comandera-stat .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .comandera-stat .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        /* ESTILOS TIPO ORDEN/COMANDA PARA BARBEROS */
        .barberos-grid-control {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        .barbero-orden {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
        }
        .barbero-orden:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.18);
        }
        .barbero-orden.activo {
            border-color: #1a1a1a;
        }
        .orden-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            color: white;
            padding: 20px;
            position: relative;
        }
        .orden-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #333;
        }
        .orden-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .orden-barbero {
            font-size: 1.4em;
            font-weight: bold;
        }
        .orden-estado {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .orden-info {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .orden-citas {
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .cita-orden {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.3s ease;
            position: relative;
        }
        .cita-orden:hover {
            background-color: #f8f9fa;
        }
        .cita-orden:last-child {
            border-bottom: none;
        }
        .cita-orden.urgente::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #dc3545;
        }
        .cita-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .cita-cliente-nombre {
            font-size: 1.2em;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 4px;
        }
        .cita-tiempo {
            background: #1a1a1a;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: auto;
        }
        .cita-fecha-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }
        .cita-hoy {
            background: #d4edda;
            color: #155724;
        }
        .cita-ma√±ana {
            background: #fff3cd;
            color: #856404;
        }
        /* NUEVOS ESTILOS PARA LOS BADGES DE FECHAS CORREGIDOS */
        .cita-proxima {
            background: #cfe2ff;
            color: #052c65;
        }
        .cita-futura {
            background: #e2e3e5;
            color: #41464b;
        }
        .cita-detalles {
            margin-bottom: 15px;
        }
        .cita-detalle-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #666;
        }
        .cita-detalle-item i {
            margin-right: 8px;
            color: #1a1a1a;
        }
        .cita-servicio-badge {
            background: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-right: 8px;
        }
        .cita-precio {
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .cita-acciones {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-accion {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-mensaje {
            background: #007bff;
            color: white;
        }
        .btn-mensaje:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .btn-cancelar {
            background: #dc3545;
            color: white;
        }
        .btn-cancelar:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        .no-citas-control {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 15px;
        }
        .no-citas-control i {
            font-size: 4em;
            color: #ddd;
            margin-bottom: 20px;
            display: block;
        }
        .no-citas-control h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .control-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .ultima-actualizacion {
            color: #666;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ultima-actualizacion::before {
            content: 'üïí';
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.3s ease;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .modal-close:hover {
            color: #333;
        }

        /* MEJORAS ESPEC√çFICAS PARA M√ìVIL - SOLO TOCO LO NECESARIO PARA EVITAR DESBORDES Y BOTONES SALIDOS */
        @media (max-width: 768px) {
            /* Padding general m√°s ajustado para que nada se salga */
            .dashboard-container {
                padding: 10px;
            }

            /* Header en columna para que no se desborde */
            .header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            .header h1 {
                font-size: 2em;
            }
            .user-info {
                justify-content: center;
                margin-top: 15px;
            }

            /* Grids principales a una columna */
            .main-grid,
            .charts-section,
            .manual-grid,
            .chart-grid {
                grid-template-columns: 1fr;
            }

            /* Stats y m√©tricas m√°s compactas pero no demasiado peque√±as */
            .stats-grid,
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            /* Categor√≠as m√°s flexibles */
            .category-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            /* Botones apilados y al 100% para que no se salgan */
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 100%;
                margin-bottom: 0;
            }

            /* Scroll horizontal suave en tablas y contenedores anchos */
            .table-container,
            .table-content {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            table {
                min-width: 700px; /* permite scroll sin romper layout */
            }

            /* Progreso y batch m√°s compactos */
            .progress-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .batch-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Filtros apilados */
            .filters-grid {
                grid-template-columns: 1fr;
            }

            /* Comandera / Control de Barberos */
            .barberos-grid-control {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .comandera-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .control-actions {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .cita-header {
                flex-direction: column;
                align-items: stretch;
            }
            .cita-tiempo {
                margin-left: 0;
                margin-top: 10px;
                margin-left: auto;
                margin-right: auto;
                width: fit-content;
            }
            .cita-acciones {
                justify-content: center;
                flex-wrap: wrap;
            }
            .btn-accion {
                flex: 1;
                min-width: 120px;
            }

            /* Evitar desbordes en textos largos */
            .cita-cliente-nombre,
            .cita-detalle-item {
                word-break: break-word;
            }
        }
    </style>
</head>

<body>
    <!-- LOGIN CONTAINER -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-logo">‚úÇÔ∏è BARBER√çA ESTILO CL√ÅSICO</div>
            <div class="login-subtitle">Dashboard de Gesti√≥n y Mensajes</div>
            <div id="loginError" class="login-error"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" id="loginBtn" class="login-btn">Iniciar Sesi√≥n</button>
            </form>
            <div class="security-info">‚úÇÔ∏è Acceso Seguro - Sistema protegido para BARBER√çA ESTILO CL√ÅSICO</div>
        </div>
    </div>

    <!-- DASHBOARD CONTAINER -->
    <div id="dashboardContainer" class="dashboard-container">
        <div class="header">
            <div>
                <h1>‚úÇÔ∏è Dashboard BARBER√çA ESTILO CL√ÅSICO <span class="optimization-badge">8 D√çAS + FIX FECHA</span></h1>
                <p>Sistema de Mensajes Masivos WhatsApp + Control de Barberos - Visualizaci√≥n 8 d√≠as futuros ‚Ä¢ Fix fecha
                    1899 ‚Ä¢ Recovery autom√°tico</p>
            </div>
            <div class="user-info">
                <span id="userEmail" class="user-email"></span>
                <button id="logoutBtn" class="logout-btn">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCitas">-</div>
                <div class="stat-label">Total Citas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalClientes">-</div>
                <div class="stat-label">Clientes √önicos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="citasHoy">-</div>
                <div class="stat-label">Citas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="valorPromedio">$-</div>
                <div class="stat-label">Valor Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mensajesEnviados">0</div>
                <div class="stat-label">Mensajes Enviados</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('categorias')">‚úÇÔ∏è Env√≠o por Categor√≠as</button>
            <button class="tab" onclick="cambiarTab('comandera')">üë®‚Äçüíº Control de Barberos (8 D√≠as)</button>
            <button class="tab" onclick="cambiarTab('manual')">‚úâÔ∏è Env√≠o Manual</button>
            <!-- ‚úÖ CAMBIO: Se quit√≥ el bot√≥n "üìä Estad√≠sticas" para que NO aparezca -->
        </div>

        <!-- Tab de Categor√≠as -->
        <div id="tab-categorias" class="tab-content active">
            <div class="main-grid">
                <div class="card">
                    <h2>Distribuci√≥n de Clientes por Categor√≠a</h2>
                    <div class="category-grid" id="categoryGrid">
                        <div class="category-item" data-category="TODOS">
                            <div class="category-name">‚úÇÔ∏è TODOS</div>
                            <div class="category-count" id="count-todos">-</div>
                            <small>Todos los clientes</small>
                        </div>
                        <div class="category-item" data-category="FRECUENTES">
                            <div class="category-name">‚≠ê FRECUENTES</div>
                            <div class="category-count" id="count-frecuentes">-</div>
                            <small>3+ citas</small>
                        </div>
                        <div class="category-item" data-category="PREMIUM">
                            <div class="category-name">üíé PREMIUM</div>
                            <div class="category-count" id="count-premium">-</div>
                            <small>Servicios +$40,000</small>
                        </div>
                        <div class="category-item" data-category="RECIENTES">
                            <div class="category-name">üïí RECIENTES</div>
                            <div class="category-count" id="count-recientes">-</div>
                            <small>√öltimos 30 d√≠as</small>
                        </div>
                        <div class="category-item" data-category="FIELES">
                            <div class="category-name">‚ù§Ô∏è FIELES</div>
                            <div class="category-count" id="count-fieles">-</div>
                            <small>5+ citas hist√≥ricas</small>
                        </div>
                    </div>

                    <!-- SECCI√ìN DE BARBEROS -->
                    <div id="barberosSection" class="barberos-section">
                        <div class="barberos-title">‚úÇÔ∏è Seleccionar Barberos:</div>
                        <button id="allBarberosBtn" class="all-barberos-btn" onclick="toggleAllBarberos()">‚úÖ TODOS LOS
                            BARBEROS</button>
                        <div class="barberos-grid" id="barberosGrid">
                            <!-- Los barberos se cargar√°n din√°micamente -->
                        </div>
                        <div class="barberos-info">
                            ‚ÑπÔ∏è <strong>Barberos seleccionados:</strong> <span id="selectedBarberosInfo">Todos los
                                barberos</span>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ CAMBIO: Se ocult√≥ SOLO el panel "Env√≠o de Mensajes por Categor√≠a" para que NO aparezca -->
                <div class="card" style="display:none;">
                    <h2>Env√≠o de Mensajes por Categor√≠a</h2>
                    <div class="form-group">
                        <label>SELECCIONAR CATEGOR√çA:</label>
                        <div id="selectedCategory"
                            style="padding: 10px; background: #f8f8f8; border-radius: 8px; text-align: center; color: #666;">
                            Selecciona una categor√≠a
                        </div>
                    </div>
                    <div class="form-group">
                        <label>PERSONALIZAR MENSAJE:</label>
                        <textarea id="mensaje" rows="5" placeholder="Hola [nombre], te invitamos a visitarnos en BARBER√çA ESTILO CL√ÅSICO...

Variables disponibles: [nombre], [citas], [valor]"></textarea>
                    </div>
                    <div class="form-group">
                        <label>URL DE IMAGEN (OPCIONAL):</label>
                        <input type="text" id="mediaUrl" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>

                    <div class="button-group">
                        <button class="btn-test" onclick="testConectividad()">‚ö° TEST CONECTIVIDAD</button>
                        <button class="btn-load" onclick="cargarDatos()">‚úÇÔ∏è CARGAR DATOS</button>
                        <button class="btn-primary" onclick="testCompleto()">‚úÖ TEST COMPLETO</button>
                    </div>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Procesando...</p>
                    </div>

                    <!-- √Årea de progreso mejorada -->
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <div class="progress-info">
                            <div>
                                <strong id="progressCurrent">0</strong> / <strong id="progressTotal">0</strong>
                                <div>Mensajes</div>
                            </div>
                            <div>
                                <strong id="progressSuccess">0</strong>
                                <div>Exitosos</div>
                            </div>
                            <div>
                                <strong id="progressErrors">0</strong>
                                <div>Errores</div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de lotes ULTRA OPTIMIZADA -->
                    <div class="batch-info" id="batchInfo">
                        <h4>‚ö° Sistema Ultra Optimizado (2 min + Recovery)</h4>
                        <p>Para grupos grandes (+5 clientes), el sistema enviar√° autom√°ticamente en lotes de 5 mensajes
                            cada <strong>2 minutos</strong> (3 segundos entre mensajes) con sistema de recovery
                            autom√°tico para m√°xima velocidad y confiabilidad.</p>
                        <div class="batch-stats">
                            <div class="batch-stat">
                                <div class="number" id="batchCurrent">-</div>
                                <div class="label">Lote Actual</div>
                            </div>
                            <div class="batch-stat">
                                <div class="number" id="batchTotal">-</div>
                                <div class="label">Total Lotes</div>
                            </div>
                            <div class="batch-stat">
                                <div class="number" id="batchEstimated">-</div>
                                <div class="label">Min Estimados</div>
                            </div>
                            <div class="batch-stat">
                                <div class="number" id="batchStatus">-</div>
                                <div class="label">Estado</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn-primary" onclick="enviarMensajes()" id="btnEnviar">üì≤ ENVIAR MENSAJES
                            MASIVOS</button>
                        <button class="btn-warning" onclick="verificarProgreso()" id="btnVerificar"
                            style="display: none;">üîÑ VERIFICAR PROGRESO</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab de Control de Barberos -->
        <div id="tab-comandera" class="tab-content">
            <div class="comandera-section">
                <div class="comandera-header">
                    <h2>üë®‚Äçüíº CONTROL DE BARBEROS (8 D√çAS)</h2>
                    <p>Sistema de gesti√≥n profesional ‚Ä¢ Citas confirmadas para los pr√≥ximos 8 d√≠as ‚Ä¢ Fix fecha 1899</p>
                    <div class="comandera-stats">
                        <div class="comandera-stat">
                            <div class="number" id="comanderaTotalCitas">-</div>
                            <div class="label">Total Citas</div>
                        </div>
                        <div class="comandera-stat">
                            <div class="number" id="comanderaCitasHoy">-</div>
                            <div class="label">Citas Hoy</div>
                        </div>
                        <div class="comandera-stat">
                            <div class="number" id="comanderaCitasMa√±ana">-</div>
                            <div class="label">Citas Ma√±ana</div>
                        </div>
                        <div class="comandera-stat">
                            <div class="number" id="comanderaBarberosActivos">-</div>
                            <div class="label">Barberos Activos</div>
                        </div>
                    </div>
                </div>

                <div class="control-actions">
                    <button class="btn-primary" onclick="cargarCitasActivas()">üîÑ Actualizar Control (8 D√≠as)</button>
                    <div class="ultima-actualizacion" id="ultimaActualizacion">
                        √öltima actualizaci√≥n: -
                    </div>
                </div>

                <div id="citasActivasContainer">
                    <div class="no-citas-control">
                        <i>üë®‚Äçüíº</i>
                        <h3>Sistema de Control Listo (8 D√≠as)</h3>
                        <p>Haz clic en "Actualizar Control" para cargar las citas de todos los barberos para los
                            pr√≥ximos 8 d√≠as</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab de Env√≠o Manual -->
        <div id="tab-manual" class="tab-content">
            <div class="manual-section">
                <h2>‚úâÔ∏è Env√≠o Manual de Mensajes</h2>
                <div class="manual-grid">
                    <div>
                        <h3>Agregar Destinatarios</h3>
                        <div class="form-group">
                            <label>N√öMERO DE TEL√âFONO:</label>
                            <input type="text" id="numeroManual" placeholder="3001234567">
                        </div>
                        <div class="form-group">
                            <label>NOMBRE (OPCIONAL):</label>
                            <input type="text" id="nombreManual" placeholder="Juan P√©rez">
                        </div>
                        <button class="btn-secondary" onclick="agregarDestinatario()" style="width: 100%;">+ Agregar a
                            la Lista</button>

                        <div style="margin: 20px 0; text-align: center;">O</div>

                        <div class="form-group">
                            <label>CARGAR ARCHIVO EXCEL:</label>
                            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="cargarExcel(event)">
                            <small style="color: #666;">Columnas: N√∫mero, Nombre</small>
                        </div>
                    </div>

                    <div>
                        <h3>Lista de Destinatarios (<span id="contadorManual">0</span>)</h3>
                        <div class="manual-list" id="listaDestinatarios">
                            <div style="text-align: center; color: #999;">No hay destinatarios agregados</div>
                        </div>
                        <button class="btn-secondary" onclick="limpiarLista()" style="width: 100%; margin-top: 10px;">‚úó
                            Limpiar Lista</button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <div class="form-group">
                        <label>MENSAJE:</label>
                        <textarea id="mensajeManual" rows="5" placeholder="Hola [nombre], queremos invitarte a disfrutar de nuestros servicios en BARBER√çA ESTILO CL√ÅSICO...

Variable disponible: [nombre]"></textarea>
                    </div>
                    <div class="form-group">
                        <label>URL DE IMAGEN (OPCIONAL):</label>
                        <input type="text" id="mediaUrlManual" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>

                    <!-- Progreso manual -->
                    <div class="progress-container" id="progressContainerManual">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFillManual">0%</div>
                        </div>
                        <div class="progress-info">
                            <div>
                                <strong id="progressCurrentManual">0</strong> / <strong
                                    id="progressTotalManual">0</strong>
                                <div>Mensajes</div>
                            </div>
                            <div>
                                <strong id="progressSuccessManual">0</strong>
                                <div>Exitosos</div>
                            </div>
                            <div>
                                <strong id="progressErrorsManual">0</strong>
                                <div>Errores</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn-manual" onclick="enviarMensajesManual()"
                        style="width: 100%; margin-top: 20px; font-size: 1.1em;">üì≤ ENVIAR MENSAJES MANUAL</button>
                </div>
            </div>
        </div>

        <!-- Tab de Estad√≠sticas -->
        <!-- ‚úÖ CAMBIO: Se dej√≥ esta secci√≥n oculta para que "Estad√≠sticas" NO aparezca nunca -->
        <div id="tab-estadisticas" class="tab-content" style="display:none;">
            <div class="stats-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìä Estad√≠sticas de Mensajes Masivos</h2>
                    <button class="btn-primary btn-small" onclick="cargarEstadisticas()">üîÑ Actualizar</button>
                </div>

                <!-- M√©tricas principales -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-number" id="metricTotal">-</div>
                        <div class="metric-label">Total Env√≠os</div>
                    </div>
                    <div class="metric-card success">
                        <div class="metric-number" id="metricEnviados">-</div>
                        <div class="metric-label">Enviados Exitosos</div>
                    </div>
                    <div class="metric-card error">
                        <div class="metric-number" id="metricErrores">-</div>
                        <div class="metric-label">Errores</div>
                    </div>
                    <div class="metric-card rate">
                        <div class="metric-number" id="metricTasa">-%</div>
                        <div class="metric-label">Tasa de √âxito</div>
                    </div>
                </div>

                <!-- Gr√°ficas -->
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>üìä Env√≠os por D√≠a (√öltimos 30 d√≠as)</h3>
                        <div class="chart-canvas">
                            <canvas id="chartEnviosDia"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>‚úÇÔ∏è Env√≠os por Categor√≠a</h3>
                        <div class="chart-canvas chart-small">
                            <canvas id="chartEnviosCategoria"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Filtros y tabla de √∫ltimos env√≠os -->
                <div style="margin-top: 30px;">
                    <h3>üìã √öltimos Env√≠os</h3>
                    <div class="filters-container">
                        <div class="filters-grid">
                            <div class="form-group">
                                <label>Categor√≠a:</label>
                                <select id="filtroCategoria">
                                    <option value="">Todas las categor√≠as</option>
                                    <option value="TODOS">Todos</option>
                                    <option value="FRECUENTES">Frecuentes</option>
                                    <option value="PREMIUM">Premium</option>
                                    <option value="RECIENTES">Recientes</option>
                                    <option value="FIELES">Fieles</option>
                                    <option value="MANUAL">Manual</option>
                                    <option value="COMANDERA_INDIVIDUAL">Control de Barberos</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estado:</label>
                                <select id="filtroEstado">
                                    <option value="">Todos los estados</option>
                                    <option value="ENVIADO">Enviados</option>
                                    <option value="ERROR">Errores</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Desde:</label>
                                <input type="date" id="filtroFechaDesde">
                            </div>
                            <div class="form-group">
                                <label>Hasta:</label>
                                <input type="date" id="filtroFechaHasta">
                            </div>
                            <div class="form-group">
                                <label>Buscar:</label>
                                <input type="text" id="filtroBusqueda" placeholder="Nombre o tel√©fono...">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-primary btn-small" onclick="aplicarFiltros()">üîç Filtrar</button>
                                <button class="btn-secondary btn-small" onclick="limpiarFiltros()">‚úó Limpiar</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h4>Registros de Env√≠os</h4>
                            <span id="totalRegistros">0 registros</span>
                        </div>
                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Nombre</th>
                                        <th>Tel√©fono</th>
                                        <th>Categor√≠a</th>
                                        <th>Estado</th>
                                        <th>Mensaje</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaEnvios">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: #999; padding: 40px;">
                                            Carga las estad√≠sticas para ver los registros
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Gr√°ficas originales -->
        <div class="charts-section">
            <div class="chart-container">
                <h3>üìä Ventas por D√≠a de la Semana</h3>
                <div class="chart-canvas">
                    <canvas id="chartDias"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3>üìà Tendencia por Meses</h3>
                <div class="chart-canvas">
                    <canvas id="chartMeses"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para env√≠o de mensaje individual -->
    <div id="modalMensaje" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="cerrarModalMensaje()">&times;</span>
            <h3>üì± Enviar Mensaje Individual</h3>
            <p style="color: #666; margin-bottom: 20px;">Desde Control de Barberos</p>
            <div class="form-group">
                <label>Cliente:</label>
                <input type="text" id="modalClienteNombre" readonly style="background: #f0f0f0;">
            </div>
            <div class="form-group">
                <label>Tel√©fono:</label>
                <input type="text" id="modalClienteTelefono" readonly style="background: #f0f0f0;">
            </div>
            <div class="form-group">
                <label>Mensaje personalizado:</label>
                <textarea id="modalMensajeTexto" rows="4"
                    placeholder="Hola [nombre], quer√≠a confirmar tu cita de hoy..."></textarea>
            </div>
            <div class="form-group">
                <label>URL de Imagen (opcional):</label>
                <input type="text" id="modalMediaUrl" placeholder="https://ejemplo.com/imagen.jpg">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" onclick="enviarMensajeIndividual()">üì± Enviar Mensaje</button>
                <button class="btn-secondary" onclick="cerrarModalMensaje()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // üö® URL CORREGIDA DE TU GOOGLE APPS SCRIPT
        // La URL se configura autom√°ticamente desde el script .gs
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyOIU6m1bZ1okayHKxKlDAZlPTbN9Ajm8vTYwkB-zaVXB7vVwesClbsKVgt_8kRcMIx-A/exec';

        let sessionToken = localStorage.getItem('sessionToken');
        let currentUser = null;
        let selectedCategory = null;
        let dashboardData = null;
        let chartDias = null;
        let chartMeses = null;
        let chartEnviosDia = null;
        let chartEnviosCategoria = null;
        let destinatariosManual = [];
        let currentJobId = null;
        let progressInterval = null;
        let estadisticasData = null;
        let citasActivasData = null;

        // Variables para barberos
        let selectedBarberos = [];
        let allBarberos = [];
        let allBarberosSelected = true;

        // Variable para datos del modal
        let modalCitaData = null;

        // Variable para auto-refresh
        let autoRefreshInterval = null;

        // ============================================
        // SISTEMA DE AUTENTICACI√ìN
        // ============================================

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideLoginError() {
            document.getElementById('loginError').style.display = 'none';
        }

        async function login(email, password) {
            try {
                console.log('=== INICIO LOGIN BARBER√çA ESTILO CL√ÅSICO ===');
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = true;
                loginBtn.textContent = 'Iniciando sesi√≥n...';

                hideLoginError();

                const formData = new FormData();
                formData.append('action', 'login');
                formData.append('email', email);
                formData.append('password', password);

                console.log('Enviando petici√≥n de login...');
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                console.log('Respuesta recibida:', response.status);
                const result = await response.json();
                console.log('Resultado login:', result);

                if (result.success) {
                    sessionToken = result.token;
                    currentUser = result.user;
                    localStorage.setItem('sessionToken', sessionToken);

                    document.getElementById('userEmail').textContent = currentUser.email;
                    showDashboard();

                    console.log('Login exitoso, cargando dashboard...');
                    setTimeout(() => {
                        cargarDatos();
                        startAutoRefresh();
                    }, 500);
                } else {
                    showLoginError(result.error || 'Error de autenticaci√≥n');
                }
            } catch (error) {
                console.error('Error en login:', error);
                showLoginError('Error de conexi√≥n. Verifica la URL del script.');
            } finally {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.textContent = 'Iniciar Sesi√≥n';
                loginBtn.disabled = false;
            }
        }

        async function logout() {
            try {
                if (sessionToken) {
                    const formData = new FormData();
                    formData.append('action', 'logout');
                    formData.append('token', sessionToken);
                    await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                }
            } catch (error) {
                console.error('Error en logout:', error);
            } finally {
                stopAutoRefresh();
                sessionToken = null;
                currentUser = null;
                localStorage.removeItem('sessionToken');
                showLogin();
            }
        }

        async function makeAuthenticatedRequest(action, additionalData = {}) {
            console.log('Haciendo petici√≥n:', action);

            try {
                const formData = new FormData();
                formData.append('action', action);
                formData.append('token', sessionToken);

                Object.keys(additionalData).forEach(key => {
                    if (typeof additionalData[key] === 'object') {
                        formData.append(key, JSON.stringify(additionalData[key]));
                    } else {
                        formData.append(key, additionalData[key]);
                    }
                });

                console.log('Enviando petici√≥n a:', SCRIPT_URL);
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                console.log('Respuesta recibida, status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Resultado parseado:', result);

                if (result.requiresLogin) {
                    await logout();
                    throw new Error('Sesi√≥n expirada');
                }

                return result;

            } catch (error) {
                console.error('Error en makeAuthenticatedRequest:', error);
                throw error;
            }
        }

        // ============================================
        // FUNCIONES DE BARBEROS
        // ============================================

        function updateBarberosDisplay(barberos) {
            console.log('Actualizando display de barberos:', barberos);

            if (!barberos || Object.keys(barberos).length === 0) {
                console.log('No hay datos de barberos');
                return;
            }

            allBarberos = Object.keys(barberos).sort();
            selectedBarberos = [...allBarberos]; // Por defecto todos seleccionados
            allBarberosSelected = true;

            const barberosGrid = document.getElementById('barberosGrid');
            barberosGrid.innerHTML = '';

            allBarberos.forEach(barbero => {
                const count = barberos[barbero] || 0;
                const barberoElement = document.createElement('div');
                barberoElement.className = 'barbero-item selected';
                barberoElement.setAttribute('data-barbero', barbero);
                barberoElement.onclick = () => toggleBarbero(barbero);

                barberoElement.innerHTML = `
                    <div class="barbero-name">${barbero}</div>
                    <div class="barbero-count">${count}</div>
                `;

                barberosGrid.appendChild(barberoElement);
            });

            updateSelectedBarberosInfo();
            console.log('Display de barberos actualizado');
        }

        function toggleBarbero(barbero) {
            const barberoElement = document.querySelector(`[data-barbero="${barbero}"]`);

            if (selectedBarberos.includes(barbero)) {
                // Remover barbero
                selectedBarberos = selectedBarberos.filter(b => b !== barbero);
                barberoElement.classList.remove('selected');
            } else {
                // Agregar barbero
                selectedBarberos.push(barbero);
                barberoElement.classList.add('selected');
            }

            // Actualizar estado del bot√≥n "Todos los barberos"
            allBarberosSelected = selectedBarberos.length === allBarberos.length;
            updateAllBarberosButton();
            updateSelectedBarberosInfo();

            // Si hay una categor√≠a seleccionada, actualizar el contador
            if (selectedCategory) {
                updateCategoryCountWithBarberos();
            }
        }

        function toggleAllBarberos() {
            allBarberosSelected = !allBarberosSelected;

            if (allBarberosSelected) {
                selectedBarberos = [...allBarberos];
                document.querySelectorAll('.barbero-item').forEach(item => {
                    item.classList.add('selected');
                });
            } else {
                selectedBarberos = [];
                document.querySelectorAll('.barbero-item').forEach(item => {
                    item.classList.remove('selected');
                });
            }

            updateAllBarberosButton();
            updateSelectedBarberosInfo();

            if (selectedCategory) {
                updateCategoryCountWithBarberos();
            }
        }

        function updateAllBarberosButton() {
            const btn = document.getElementById('allBarberosBtn');
            if (allBarberosSelected) {
                btn.textContent = '‚ùå DESELECCIONAR TODOS';
                btn.className = 'all-barberos-btn active';
            } else {
                btn.textContent = '‚úÖ SELECCIONAR TODOS';
                btn.className = 'all-barberos-btn';
            }
        }

        function updateSelectedBarberosInfo() {
            const info = document.getElementById('selectedBarberosInfo');
            if (selectedBarberos.length === 0) {
                info.textContent = 'Ning√∫n barbero seleccionado';
            } else if (selectedBarberos.length === allBarberos.length) {
                info.textContent = 'Todos los barberos seleccionados';
            } else {
                info.textContent = `${selectedBarberos.length} barberos: ${selectedBarberos.join(', ')}`;
            }
        }

        function updateCategoryCountWithBarberos() {
            if (!selectedCategory || !dashboardData || !dashboardData.categorias) return;

            const clientes = dashboardData.categorias[selectedCategory] || [];
            const clientesFiltrados = clientes.filter(cliente => {
                if (selectedBarberos.length === 0) return false;
                if (selectedBarberos.length === allBarberos.length) return true;

                // Verificar si el cliente tiene alg√∫n barbero seleccionado
                const barberosCliente = cliente.barberosArray || [];
                return barberosCliente.some(barbero => selectedBarberos.includes(barbero));
            });

            // Actualizar el display de categor√≠a seleccionada
            const categoryName = document.querySelector(`[data-category="${selectedCategory}"] .category-name`).textContent;
            const barberosTexto = selectedBarberos.length === allBarberos.length ?
                'todos los barberos' :
                `${selectedBarberos.length} barbero${selectedBarberos.length > 1 ? 's' : ''}`;

            document.getElementById('selectedCategory').textContent =
                `${categoryName} - ${clientesFiltrados.length} clientes (${barberosTexto})`;
        }

        // ============================================
        // FUNCIONES DE CONTROL DE BARBEROS - CORREGIDAS PARA 8 D√çAS
        // ============================================

        async function cargarCitasActivas() {
            showLoading(true);
            try {
                const result = await makeAuthenticatedRequest('loadCitasActivas');
                console.log('Control de barberos recibido (8 d√≠as):', result);

                if (result.success) {
                    citasActivasData = result;
                    actualizarComanderoStats(result.resumen);
                    renderizarCitasActivas(result.citasPorBarbero);
                    document.getElementById('ultimaActualizacion').textContent =
                        `√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`;
                    showAlert('‚úì Control de barberos actualizado correctamente (8 d√≠as futuros)', 'success');
                } else {
                    throw new Error(result.error || 'Error cargando el control');
                }
            } catch (error) {
                console.error('Error cargando control de barberos:', error);
                showAlert('‚úó Error cargando control: ' + error.message, 'error');
            }
            showLoading(false);
        }

        function actualizarComanderoStats(resumen) {
            document.getElementById('comanderaTotalCitas').textContent = resumen.totalCitas || '0';
            document.getElementById('comanderaCitasHoy').textContent = resumen.citasHoy || '0';
            document.getElementById('comanderaCitasMa√±ana').textContent = resumen.citasMa√±ana || '0';
            document.getElementById('comanderaBarberosActivos').textContent = resumen.barberosActivos || '0';
        }

        // FUNCI√ìN CORREGIDA PARA MANEJAR 8 D√çAS Y BADGES DE FECHA MEJORADOS
        function renderizarCitasActivas(citasPorBarbero) {
            const container = document.getElementById('citasActivasContainer');

            if (!citasPorBarbero || Object.keys(citasPorBarbero).length === 0) {
                container.innerHTML = `
                    <div class="no-citas-control">
                        <i>üë®‚Äçüíº</i>
                        <h3>No hay citas activas</h3>
                        <p>No se encontraron citas confirmadas para los pr√≥ximos 8 d√≠as</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="barberos-grid-control">';

            Object.keys(citasPorBarbero).forEach(barbero => {
                const citas = citasPorBarbero[barbero];
                const citasHoy = citas.filter(c => c.esHoy).length;
                const citasMa√±ana = citas.filter(c => c.esMa√±ana).length;
                const citasProximas = citas.filter(c => c.diasHastaCita > 1).length;
                const totalValor = citas.reduce((sum, c) => sum + (c.valor || 0), 0);

                html += `
                    <div class="barbero-orden ${citas.length > 0 ? 'activo' : ''}">
                        <div class="orden-header">
                            <div class="orden-title">
                                <div class="orden-barbero">‚úÇÔ∏è ${barbero}</div>
                                <div class="orden-estado">ACTIVO</div>
                            </div>
                            <div class="orden-info">
                                ${citas.length} cita${citas.length > 1 ? 's' : ''} ‚Ä¢ 
                                Hoy: ${citasHoy} ‚Ä¢ Ma√±ana: ${citasMa√±ana} ‚Ä¢ 
                                Pr√≥ximos 8 d√≠as: ${citasProximas} ‚Ä¢ 
                                Total: $${totalValor.toLocaleString()}
                            </div>
                        </div>
                        <div class="orden-citas">
                `;

                citas.forEach((cita, index) => {
                    // Determinar el badge de fecha corregido
                    let fechaClass = '';
                    let fechaTexto = '';

                    if (cita.esHoy) {
                        fechaClass = 'cita-hoy';
                        fechaTexto = 'HOY';
                    } else if (cita.esMa√±ana) {
                        fechaClass = 'cita-ma√±ana';
                        fechaTexto = 'MA√ëANA';
                    } else if (cita.diasHastaCita <= 3) {
                        fechaClass = 'cita-proxima';
                        fechaTexto = `EN ${cita.diasHastaCita} D√çAS`;
                    } else {
                        fechaClass = 'cita-futura';
                        fechaTexto = cita.fechaCitaCorta;
                    }

                    const isUrgente = cita.esHoy && new Date().getHours() > 16;

                    html += `
                        <div class="cita-orden ${isUrgente ? 'urgente' : ''}">
                            <div class="cita-header">
                                <div>
                                    <div class="cita-cliente-nombre">${cita.cliente}</div>
                                    <div class="cita-detalle-item">
                                        <i>üìû</i> ${cita.telefono}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <div class="cita-tiempo">${cita.horaCita}</div>
                                    <div class="cita-fecha-badge ${fechaClass}">${fechaTexto}</div>
                                </div>
                            </div>
                            
                            <div class="cita-detalles">
                                <div class="cita-detalle-item">
                                    <i>‚úÇÔ∏è</i> 
                                    <span class="cita-servicio-badge">${cita.servicio}</span>
                                    <span class="cita-precio">$${cita.valor?.toLocaleString() || '0'}</span>
                                </div>
                                ${cita.email ? `
                                <div class="cita-detalle-item">
                                    <i>üìß</i> ${cita.email}
                                </div>
                                ` : ''}
                                <div class="cita-detalle-item">
                                    <i>üìÖ</i> ${cita.fechaCita}
                                </div>
                                <div class="cita-detalle-item">
                                    <i>üÜî</i> C√≥digo: ${cita.codigoReserva}
                                </div>
                            </div>
                            
                            <div class="cita-acciones">
                                <button class="btn-accion btn-mensaje" onclick="abrirModalMensaje('${cita.codigoReserva}')">
                                    üì± Mensaje
                                </button>
                                <button class="btn-accion btn-cancelar" onclick="cancelarCita('${cita.codigoReserva}', '${cita.cliente}', ${cita.fila})">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function abrirModalMensaje(codigoReserva) {
            // Buscar la cita en los datos
            if (!citasActivasData || !citasActivasData.citasActivas) {
                showAlert('Error: No hay datos de citas cargados', 'error');
                return;
            }

            const cita = citasActivasData.citasActivas.find(c => c.codigoReserva === codigoReserva);
            if (!cita) {
                showAlert('Error: Cita no encontrada', 'error');
                return;
            }

            modalCitaData = cita;

            // Crear mensaje personalizado seg√∫n los d√≠as hasta la cita
            let mensajePredeterminado = '';
            if (cita.esHoy) {
                mensajePredeterminado = `Hola ${cita.cliente}, te escribo de Barber√≠a Estilo Cl√°sico para confirmar tu cita de HOY a las ${cita.horaCita}. ¬øConfirmas tu asistencia? ‚úÇÔ∏è`;
            } else if (cita.esMa√±ana) {
                mensajePredeterminado = `Hola ${cita.cliente}, te escribo de Barber√≠a Estilo Cl√°sico para recordarte tu cita de MA√ëANA a las ${cita.horaCita}. ¬øConfirmas tu asistencia? ‚úÇÔ∏è`;
            } else {
                mensajePredeterminado = `Hola ${cita.cliente}, te escribo de Barber√≠a Estilo Cl√°sico para recordarte tu cita del ${cita.fechaCitaCorta} a las ${cita.horaCita}. ¬øConfirmas tu asistencia? ‚úÇÔ∏è`;
            }

            // Llenar el modal
            document.getElementById('modalClienteNombre').value = cita.cliente;
            document.getElementById('modalClienteTelefono').value = cita.telefono;
            document.getElementById('modalMensajeTexto').value = mensajePredeterminado;
            document.getElementById('modalMediaUrl').value = '';

            // Mostrar modal
            document.getElementById('modalMensaje').style.display = 'block';
        }

        function cerrarModalMensaje() {
            document.getElementById('modalMensaje').style.display = 'none';
            modalCitaData = null;
        }

        async function enviarMensajeIndividual() {
            if (!modalCitaData) {
                showAlert('Error: No hay datos de cita', 'error');
                return;
            }

            const mensaje = document.getElementById('modalMensajeTexto').value.trim();
            if (!mensaje) {
                showAlert('Por favor escribe un mensaje', 'error');
                return;
            }

            const mediaUrl = document.getElementById('modalMediaUrl').value.trim();

            try {
                showLoading(true);

                const result = await makeAuthenticatedRequest('enviarMensajeIndividual', {
                    telefono: modalCitaData.telefono,
                    mensaje: mensaje,
                    mediaUrl: mediaUrl,
                    clienteNombre: modalCitaData.cliente,
                    codigoReserva: modalCitaData.codigoReserva
                });

                if (result.success) {
                    showAlert('‚úì Mensaje enviado exitosamente', 'success');
                    cerrarModalMensaje();
                } else {
                    throw new Error(result.error || 'Error enviando mensaje');
                }
            } catch (error) {
                console.error('Error enviando mensaje individual:', error);
                showAlert('‚úó Error enviando mensaje: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function cancelarCita(codigoReserva, clienteNombre, fila) {
            if (!confirm(`¬øEst√°s seguro de cancelar la cita de ${clienteNombre}?`)) {
                return;
            }

            try {
                showLoading(true);

                const result = await makeAuthenticatedRequest('cancelarCita', {
                    fila: fila,
                    codigoReserva: codigoReserva,
                    clienteNombre: clienteNombre
                });

                if (result.success) {
                    showAlert('‚úì Cita cancelada exitosamente', 'success');
                    // Recargar las citas activas
                    setTimeout(cargarCitasActivas, 1000);
                } else {
                    throw new Error(result.error || 'Error cancelando cita');
                }
            } catch (error) {
                console.error('Error cancelando cita:', error);
                showAlert('‚úó Error cancelando cita: ' + error.message, 'error');
            }
            showLoading(false);
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        document.addEventListener('DOMContentLoaded', function () {
            console.log('Dashboard BARBER√çA ESTILO CL√ÅSICO iniciado - Versi√≥n 8 d√≠as + Fix fecha 1899');

            document.getElementById('loginForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                login(email, password);
            });

            document.getElementById('logoutBtn').addEventListener('click', logout);

            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', function () {
                    selectCategory(this);
                });
            });

            // Cerrar modal al hacer clic fuera de √©l
            window.onclick = function (event) {
                const modal = document.getElementById('modalMensaje');
                if (event.target === modal) {
                    cerrarModalMensaje();
                }
            };

            inicializarGraficas();
            inicializarGraficasEstadisticas();

            if (sessionToken) {
                console.log('Token encontrado, validando sesi√≥n...');
                makeAuthenticatedRequest('test').then(result => {
                    if (result.success) {
                        currentUser = result.user;
                        document.getElementById('userEmail').textContent = currentUser.email;
                        showDashboard();
                        setTimeout(() => {
                            cargarDatos();
                            startAutoRefresh();
                        }, 500);
                    } else {
                        showLogin();
                    }
                }).catch(() => showLogin());
            } else {
                showLogin();
            }
        });

        // ============================================
        // FUNCIONES DEL DASHBOARD
        // ============================================

        function cambiarTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');

            if (tab === 'estadisticas' && !estadisticasData) {
                setTimeout(cargarEstadisticas, 500);
            } else if (tab === 'comandera' && !citasActivasData) {
                setTimeout(cargarCitasActivas, 500);
            }
        }

        function selectCategory(element) {
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('selected');
            });

            element.classList.add('selected');
            selectedCategory = element.dataset.category;

            // Mostrar la secci√≥n de barberos
            document.getElementById('barberosSection').classList.add('active');

            updateCategoryCountWithBarberos();
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function showLoading(show = true) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        // ============================================
        // FUNCIONES DE GR√ÅFICAS
        // ============================================

        function inicializarGraficas() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            };

            const ctxDias = document.getElementById('chartDias').getContext('2d');
            chartDias = new Chart(ctxDias, {
                type: 'bar',
                data: {
                    labels: ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'],
                    datasets: [{
                        label: 'Ventas',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(26, 26, 26, 0.6)',
                        borderColor: 'rgba(26, 26, 26, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Valor en Ventas ($)' }
                        }
                    }
                }
            });

            const ctxMeses = document.getElementById('chartMeses').getContext('2d');
            chartMeses = new Chart(ctxMeses, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ventas',
                        data: [],
                        backgroundColor: 'rgba(51, 51, 51, 0.2)',
                        borderColor: 'rgba(51, 51, 51, 1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Valor en Ventas ($)' }
                        }
                    }
                }
            });
        }

        function inicializarGraficasEstadisticas() {
            const ctxEnviosDia = document.getElementById('chartEnviosDia').getContext('2d');
            chartEnviosDia = new Chart(ctxEnviosDia, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Enviados',
                        data: [],
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Errores',
                        data: [],
                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const ctxEnviosCategoria = document.getElementById('chartEnviosCategoria').getContext('2d');
            chartEnviosCategoria = new Chart(ctxEnviosCategoria, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#1a1a1a', '#333', '#666', '#999',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' }
                    }
                }
            });
        }

        // ============================================
        // FUNCIONES DE DATOS
        // ============================================

        async function cargarDatos() {
            console.log('Iniciando carga de datos BARBER√çA...');
            showLoading(true);
            try {
                const result = await makeAuthenticatedRequest('loadData');
                console.log('Datos recibidos:', result);

                if (result.success) {
                    dashboardData = result;

                    // Actualizar dashboard principal
                    if (result.stats) {
                        actualizarDashboard(result.stats);
                        console.log('Stats actualizados:', result.stats);
                    }

                    // Actualizar categor√≠as
                    if (result.categorias) {
                        actualizarCategorias(result.categorias);
                        console.log('Categor√≠as actualizadas:', result.categorias);
                    }

                    // Actualizar gr√°ficas
                    if (result.graficas) {
                        actualizarGraficas(result.graficas);
                        console.log('Gr√°ficas actualizadas');
                    }

                    // Actualizar barberos
                    if (result.barberos) {
                        updateBarberosDisplay(result.barberos);
                        console.log('Barberos actualizados:', result.barberos);
                    }

                    showAlert('‚úì Datos de BARBER√çA ESTILO CL√ÅSICO cargados correctamente', 'success');
                } else {
                    console.error('Error en la respuesta:', result.error);
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error completo:', error);
                showAlert('‚úó Error cargando datos: ' + error.message, 'error');

                // Mostrar valores por defecto en caso de error
                document.getElementById('totalCitas').textContent = '0';
                document.getElementById('totalClientes').textContent = '0';
                document.getElementById('citasHoy').textContent = '0';
                document.getElementById('valorPromedio').textContent = '$0';
                document.getElementById('mensajesEnviados').textContent = '0';
            }
            showLoading(false);
        }


        // ============================================
        // FUNCI√ìN DE AUTO-REFRESH CADA 30 SEGUNDOS
        // ============================================
        async function autoRefreshDatos() {
            console.log('Auto-refresh ejecut√°ndose...');
            try {
                // Solo refrescar si estamos en el dashboard y hay sesi√≥n activa
                if (sessionToken && document.getElementById('dashboardContainer').style.display !== 'none') {
                    const result = await makeAuthenticatedRequest('loadData');

                    if (result.success) {
                        dashboardData = result;

                        // Actualizar solo los datos sin mostrar loading ni alertas
                        if (result.stats) {
                            actualizarDashboard(result.stats);
                        }
                        if (result.categorias) {
                            actualizarCategorias(result.categorias);
                        }
                        if (result.graficas) {
                            actualizarGraficas(result.graficas);
                        }
                        if (result.barberos) {
                            updateBarberosDisplay(result.barberos);
                        }

                        console.log('Auto-refresh completado exitosamente');
                    }
                }
            } catch (error) {
                console.error('Error en auto-refresh:', error);
                // Si hay error de sesi√≥n, detener auto-refresh
                if (error.message.includes('Sesi√≥n expirada')) {
                    stopAutoRefresh();
                }
            }
        }

        function startAutoRefresh() {
            // Limpiar intervalo anterior si existe
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // Iniciar nuevo intervalo de 30 segundos
            autoRefreshInterval = setInterval(autoRefreshDatos, 30000);
            console.log('Auto-refresh iniciado: cada 30 segundos');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('Auto-refresh detenido');
            }
        }



        function actualizarDashboard(stats) {
            console.log('Actualizando dashboard con:', stats);

            // Actualizar estad√≠sticas principales
            if (stats.totalCitas !== undefined) {
                document.getElementById('totalCitas').textContent = stats.totalCitas;
            }
            if (stats.totalClientes !== undefined) {
                document.getElementById('totalClientes').textContent = stats.totalClientes;
            }
            if (stats.citasHoy !== undefined) {
                document.getElementById('citasHoy').textContent = stats.citasHoy;
            }
            if (stats.valorPromedio !== undefined) {
                document.getElementById('valorPromedio').textContent = '$' + (stats.valorPromedio || '0');
            }
            if (stats.mensajesEnviados !== undefined) {
                document.getElementById('mensajesEnviados').textContent = stats.mensajesEnviados || '0';
            }

            console.log('Dashboard actualizado exitosamente');
        }

        function actualizarCategorias(categorias) {
            if (!categorias) {
                console.log('No hay categor√≠as para actualizar');
                return;
            }

            console.log('Actualizando categor√≠as:', categorias);

            // Actualizar contadores de categor√≠as
            if (categorias.TODOS) {
                document.getElementById('count-todos').textContent = categorias.TODOS.length;
            }
            if (categorias.FRECUENTES) {
                document.getElementById('count-frecuentes').textContent = categorias.FRECUENTES.length;
            }
            if (categorias.PREMIUM) {
                document.getElementById('count-premium').textContent = categorias.PREMIUM.length;
            }
            if (categorias.RECIENTES) {
                document.getElementById('count-recientes').textContent = categorias.RECIENTES.length;
            }
            if (categorias.FIELES) {
                document.getElementById('count-fieles').textContent = categorias.FIELES.length;
            }

            console.log('Categor√≠as actualizadas exitosamente');
        }

        function actualizarGraficas(graficas) {
            if (!graficas) return;
            console.log('Actualizando gr√°ficas con:', graficas);

            if (graficas.porDiaSemana && chartDias) {
                const labels = graficas.porDiaSemana.map(d => d.dia);
                const data = graficas.porDiaSemana.map(d => d.valor);
                chartDias.data.labels = labels;
                chartDias.data.datasets[0].data = data;
                chartDias.update();
            }

            if (graficas.porMes && chartMeses) {
                const labels = graficas.porMes.map(m => m.mes);
                const data = graficas.porMes.map(m => m.valor);
                chartMeses.data.labels = labels;
                chartMeses.data.datasets[0].data = data;
                chartMeses.update();
            }
        }

        // ============================================
        // FUNCIONES DE ENV√çO (MODIFICADAS PARA BARBEROS)
        // ============================================

        async function enviarMensajes() {
            if (!selectedCategory) {
                showAlert('‚ö† Por favor selecciona una categor√≠a', 'error');
                return;
            }

            if (selectedBarberos.length === 0) {
                showAlert('‚ö† Por favor selecciona al menos un barbero', 'error');
                return;
            }

            const mensaje = document.getElementById('mensaje').value.trim();
            if (!mensaje) {
                showAlert('‚ö† Por favor escribe un mensaje', 'error');
                return;
            }

            const mediaUrl = document.getElementById('mediaUrl').value.trim();

            // Calcular clientes filtrados por barbero
            const clientes = dashboardData.categorias[selectedCategory] || [];
            const clientesFiltrados = clientes.filter(cliente => {
                if (selectedBarberos.length === allBarberos.length) return true;
                const barberosCliente = cliente.barberosArray || [];
                return barberosCliente.some(barbero => selectedBarberos.includes(barbero));
            });

            const clientCount = clientesFiltrados.length;

            let confirmMessage = `¬øEst√°s seguro de enviar mensajes a la categor√≠a ${selectedCategory}?`;
            confirmMessage += `\n\nClientes seleccionados: ${clientCount}`;
            confirmMessage += `\nBarberos: ${selectedBarberos.length === allBarberos.length ? 'Todos' : selectedBarberos.join(', ')}`;

            if (clientCount > 5) {
                confirmMessage += `\n\n‚ö° GRUPO GRANDE DETECTADO: ${clientCount} clientes\n`;
                confirmMessage += `El sistema ULTRA OPTIMIZADO enviar√° autom√°ticamente en ${Math.ceil(clientCount / 5)} lotes de 5 mensajes cada 2 minutos.\n`;
                confirmMessage += `Tiempo estimado: ${Math.ceil(clientCount / 5) * 2} minutos (con recovery autom√°tico).`;
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading(true);
            document.getElementById('progressContainer').classList.add('active');
            updateProgress(0, clientCount, 0, 0);

            try {
                const result = await makeAuthenticatedRequest('sendMessages', {
                    categoria: selectedCategory,
                    mensaje: mensaje,
                    mediaUrl: mediaUrl,
                    barberosSeleccionados: selectedBarberos // NUEVO: Enviar barberos seleccionados
                });

                console.log('Respuesta de env√≠o ULTRA OPTIMIZADO:', result);

                if (result.success) {
                    if (result.batchMode) {
                        currentJobId = result.jobId;
                        showAlert('‚ö° Proceso ULTRA OPTIMIZADO iniciado. Monitorea el progreso abajo.', 'info');

                        document.getElementById('batchInfo').classList.add('active');
                        document.getElementById('batchTotal').textContent = result.totalBatches;
                        document.getElementById('batchEstimated').textContent = result.estimatedMinutes || '-';
                        document.getElementById('batchStatus').textContent = 'Ejecutando';

                        document.getElementById('btnEnviar').style.display = 'none';
                        document.getElementById('btnVerificar').style.display = 'block';

                        startProgressMonitoring();
                    } else {
                        updateProgress(result.total, result.total, result.enviados, result.errores);
                        showAlert(`‚úì Env√≠o completado: ${result.enviados}/${result.total} mensajes enviados`, 'success');

                        setTimeout(() => {
                            cargarDatos();
                            if (estadisticasData) cargarEstadisticas();
                        }, 1000);
                    }
                } else {
                    throw new Error(result.error || 'Error al enviar mensajes');
                }
            } catch (error) {
                showAlert('‚úó Error enviando mensajes: ' + error.message, 'error');
                document.getElementById('progressContainer').classList.remove('active');
            }

            showLoading(false);
        }

        async function verificarProgreso() {
            try {
                const result = await makeAuthenticatedRequest('checkProgress');
                console.log('Progreso ULTRA OPTIMIZADO:', result);

                if (result.success && result.active) {
                    updateProgress(result.currentIndex, result.total, result.enviados, result.errores);

                    document.getElementById('batchCurrent').textContent = result.batchesCompleted || 0;
                    document.getElementById('batchStatus').textContent = result.isStuck ? 'RECOVERY' : (result.status || 'Ejecutando');

                    let mensaje = `‚ö° Progreso: ${result.progress}% - Lote ${result.batchesCompleted || 0}/${result.totalBatches || 0}`;
                    if (result.isStuck) {
                        mensaje += ' (Sistema de recovery activado)';
                    }
                    showAlert(mensaje, 'info');
                } else {
                    stopProgressMonitoring();
                    document.getElementById('batchStatus').textContent = 'Completado';
                    document.getElementById('btnEnviar').style.display = 'block';
                    document.getElementById('btnVerificar').style.display = 'none';

                    if (result.active === false) {
                        showAlert('‚úì Proceso ULTRA OPTIMIZADO completado', 'success');
                        setTimeout(() => {
                            cargarDatos();
                            if (estadisticasData) cargarEstadisticas();
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('Error verificando progreso:', error);
                showAlert('‚úó Error verificando progreso: ' + error.message, 'error');
            }
        }

        function startProgressMonitoring() {
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(async () => {
                await verificarProgreso();
            }, 8000);
        }

        function stopProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function updateProgress(current, total, success, errors) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            document.getElementById('progressFill').textContent = `${percentage}%`;
            document.getElementById('progressCurrent').textContent = current;
            document.getElementById('progressTotal').textContent = total;
            document.getElementById('progressSuccess').textContent = success;
            document.getElementById('progressErrors').textContent = errors;
        }

        // ============================================
        // FUNCIONES DE TESTING
        // ============================================

        async function testConectividad() {
            showLoading(true);
            try {
                const result = await makeAuthenticatedRequest('test');
                showAlert('‚úì Conexi√≥n establecida con BARBER√çA ESTILO CL√ÅSICO', 'success');
            } catch (error) {
                showAlert('‚úó Error de conexi√≥n: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function testCompleto() {
            showLoading(true);
            try {
                const result = await makeAuthenticatedRequest('testComplete');
                console.log('Test completo respuesta:', result);

                if (result.success) {
                    let mensaje = '‚úÖ RESULTADOS DEL TEST BARBER√çA ESTILO CL√ÅSICO:\n';
                    mensaje += `‚úì Google Sheets: ${result.tests.googleSheets}\n`;
                    mensaje += `‚úì Datos disponibles: ${result.tests.datosDisponibles}\n`;
                    mensaje += `‚úì API BuilderBot: ${result.tests.apiBuilderBot}\n`;
                    mensaje += `‚úì Categorizaci√≥n: ${result.tests.categorizacionBarberia}\n`;
                    mensaje += `‚úì Hoja MASIVOS: ${result.tests.masivosSheet}\n`;
                    mensaje += `‚úì Sistema de Barberos: ${result.tests.sistemaBarberos}\n`;
                    mensaje += `‚úì Control de Barberos: ${result.tests.comanderaDigital}\n`;
                    mensaje += `‚ö° Optimizaci√≥n: ${result.tests.triggerOptimization}\n`;
                    mensaje += `‚ô• Sistema Heartbeat: ${result.tests.heartbeatSystem}\n`;
                    mensaje += `‚úì Total citas: ${result.tests.totalCitas}\n`;
                    mensaje += `‚úÇÔ∏è Empresa: ${result.tests.empresa}\n`;
                    mensaje += `üîß Versi√≥n: ${result.tests.versionCorregida}\n\n`;

                    alert(mensaje);
                    showAlert('‚úì Test BARBER√çA ESTILO CL√ÅSICO exitoso - Versi√≥n 8 d√≠as + Fix fecha 1899', 'success');
                } else {
                    throw new Error(result.error || 'Error en el test');
                }
            } catch (error) {
                showAlert('‚úó Error en test: ' + error.message, 'error');
            }
            showLoading(false);
        }

        // ============================================
        // FUNCIONES MANUALES
        // ============================================

        function agregarDestinatario() {
            const numero = document.getElementById('numeroManual').value.trim();
            const nombre = document.getElementById('nombreManual').value.trim() || 'Cliente';

            if (!numero) {
                showAlert('‚ö† Por favor ingresa un n√∫mero', 'error');
                return;
            }

            if (destinatariosManual.find(d => d.numero === numero)) {
                showAlert('‚ö† Este n√∫mero ya est√° en la lista', 'error');
                return;
            }

            destinatariosManual.push({ numero, nombre });
            actualizarListaDestinatarios();

            document.getElementById('numeroManual').value = '';
            document.getElementById('nombreManual').value = '';
        }

        function actualizarListaDestinatarios() {
            const lista = document.getElementById('listaDestinatarios');
            const contador = document.getElementById('contadorManual');

            contador.textContent = destinatariosManual.length;

            if (destinatariosManual.length === 0) {
                lista.innerHTML = '<div style="text-align: center; color: #999;">No hay destinatarios agregados</div>';
                return;
            }

            lista.innerHTML = destinatariosManual.map((dest, index) => `
                <div class="manual-item">
                    <span>${dest.nombre} - ${dest.numero}</span>
                    <button onclick="eliminarDestinatario(${index})" style="background: #dc3545; color: white; border: none; padding: 2px 10px; border-radius: 4px; cursor: pointer;">‚úï</button>
                </div>
            `).join('');
        }

        function eliminarDestinatario(index) {
            destinatariosManual.splice(index, 1);
            actualizarListaDestinatarios();
        }

        function limpiarLista() {
            if (confirm('¬øEst√°s seguro de limpiar toda la lista?')) {
                destinatariosManual = [];
                actualizarListaDestinatarios();
            }
        }

        function cargarExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    console.log('Datos Excel:', jsonData);

                    jsonData.forEach(row => {
                        const numero = String(row['Numero'] || row['N√∫mero'] || row['Telefono'] || row['Tel√©fono'] || '').trim();
                        const nombre = String(row['Nombre'] || row['Cliente'] || 'Cliente').trim();

                        if (numero && !destinatariosManual.find(d => d.numero === numero)) {
                            destinatariosManual.push({ numero, nombre });
                        }
                    });

                    actualizarListaDestinatarios();
                    showAlert(`‚úì Se cargaron ${jsonData.length} registros del Excel`, 'success');
                } catch (error) {
                    console.error('Error procesando Excel:', error);
                    showAlert('‚úó Error al procesar el archivo Excel', 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        async function enviarMensajesManual() {
            if (destinatariosManual.length === 0) {
                showAlert('‚ö† No hay destinatarios en la lista', 'error');
                return;
            }

            const mensaje = document.getElementById('mensajeManual').value.trim();
            if (!mensaje) {
                showAlert('‚ö† Por favor escribe un mensaje', 'error');
                return;
            }

            const mediaUrl = document.getElementById('mediaUrlManual').value.trim();

            let confirmMessage = `¬øEst√°s seguro de enviar mensajes a ${destinatariosManual.length} destinatarios?`;
            if (destinatariosManual.length > 5) {
                confirmMessage += `\n\n‚ö° GRUPO GRANDE: Se enviar√° con sistema ULTRA OPTIMIZADO.`;
            }

            if (!confirm(confirmMessage)) return;

            showLoading(true);
            document.getElementById('progressContainerManual').classList.add('active');

            try {
                const result = await makeAuthenticatedRequest('sendManual', {
                    numeros: destinatariosManual,
                    mensaje: mensaje,
                    mediaUrl: mediaUrl
                });

                console.log('Respuesta env√≠o manual:', result);

                if (result.success) {
                    showAlert(`‚úì Mensajes enviados: ${result.enviados}/${result.total} (Errores: ${result.errores})`, 'success');

                    if (confirm('¬øDeseas limpiar la lista de destinatarios?')) {
                        limpiarLista();
                    }

                    setTimeout(() => {
                        cargarDatos();
                        if (estadisticasData) cargarEstadisticas();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Error al enviar mensajes');
                }
            } catch (error) {
                showAlert('‚úó Error enviando mensajes: ' + error.message, 'error');
            }

            showLoading(false);
            document.getElementById('progressContainerManual').classList.remove('active');
        }

        // ============================================
        // FUNCIONES DE ESTAD√çSTICAS
        // ============================================

        async function cargarEstadisticas() {
            showLoading(true);
            try {
                const result = await makeAuthenticatedRequest('getEstadisticasCompletas');
                console.log('Estad√≠sticas recibidas:', result);

                if (result.success) {
                    estadisticasData = result;
                    actualizarMetricas(result.metricas);
                    actualizarGraficasEstadisticas(result);
                    cargarUltimosEnvios();
                    showAlert('‚úì Estad√≠sticas cargadas correctamente', 'success');
                } else {
                    throw new Error(result.error || 'Error cargando estad√≠sticas');
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                showAlert('‚úó Error cargando estad√≠sticas: ' + error.message, 'error');
            }
            showLoading(false);
        }

        function actualizarMetricas(metricas) {
            document.getElementById('metricTotal').textContent = metricas.totalEnvios;
            document.getElementById('metricEnviados').textContent = metricas.enviados;
            document.getElementById('metricErrores').textContent = metricas.errores;
            document.getElementById('metricTasa').textContent = metricas.tasaExito + '%';
        }

        function actualizarGraficasEstadisticas(data) {
            if (data.porDia && chartEnviosDia) {
                const labels = data.porDia.map(d => {
                    const fecha = new Date(d.fecha);
                    return fecha.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                });
                const enviados = data.porDia.map(d => d.enviados);
                const errores = data.porDia.map(d => d.errores);

                chartEnviosDia.data.labels = labels;
                chartEnviosDia.data.datasets[0].data = enviados;
                chartEnviosDia.data.datasets[1].data = errores;
                chartEnviosDia.update();
            }

            if (data.porCategoria && chartEnviosCategoria) {
                const labels = data.porCategoria.map(c => c.categoria);
                const totales = data.porCategoria.map(c => c.total);

                chartEnviosCategoria.data.labels = labels;
                chartEnviosCategoria.data.datasets[0].data = totales;
                chartEnviosCategoria.update();
            }
        }

        async function cargarUltimosEnvios(filtros = {}) {
            try {
                const result = await makeAuthenticatedRequest('getUltimosEnvios', {
                    limit: 100,
                    filtros: filtros
                });

                if (result.success) {
                    actualizarTablaEnvios(result.envios);
                    document.getElementById('totalRegistros').textContent = `${result.envios.length} de ${result.total} registros`;
                } else {
                    throw new Error(result.error || 'Error cargando env√≠os');
                }
            } catch (error) {
                console.error('Error cargando env√≠os:', error);
                showAlert('‚úó Error cargando env√≠os: ' + error.message, 'error');
            }
        }

        function actualizarTablaEnvios(envios) {
            const tbody = document.getElementById('tablaEnvios');
            if (envios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">No hay registros para mostrar</td></tr>';
                return;
            }

            tbody.innerHTML = envios.map(envio => {
                const fecha = new Date(envio.fecha).toLocaleString('es-ES');
                const statusClass = envio.estado === 'ENVIADO' ? 'status-enviado' : 'status-error';
                const mensaje = envio.mensaje ? envio.mensaje.substring(0, 50) + '...' : '';

                return `
                    <tr>
                        <td>${fecha}</td>
                        <td>${envio.nombre}</td>
                        <td>${envio.telefono}</td>
                        <td>${envio.categoria}</td>
                        <td><span class="status-badge ${statusClass}">${envio.estado}</span></td>
                        <td title="${envio.mensaje}">${mensaje}</td>
                    </tr>
                `;
            }).join('');
        }

        function aplicarFiltros() {
            const filtros = {
                categoria: document.getElementById('filtroCategoria').value,
                estado: document.getElementById('filtroEstado').value,
                fechaDesde: document.getElementById('filtroFechaDesde').value,
                fechaHasta: document.getElementById('filtroFechaHasta').value,
                busqueda: document.getElementById('filtroBusqueda').value
            };
            cargarUltimosEnvios(filtros);
        }

        function limpiarFiltros() {
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroFechaDesde').value = '';
            document.getElementById('filtroFechaHasta').value = '';
            document.getElementById('filtroBusqueda').value = '';
            cargarUltimosEnvios();
        }
    </script>
</body>

</html>
